create or replace view pdh_ref_ds.ref_qc_redemption_charges_rate
as
select 
distinct 
merchant
,case
when s.division IN ('EG Group','EG APAC') then cast(-0.03 as numeric)
when qc.OutletGroup IN ('EG Group','EG APAC')  then cast(-0.03 as numeric)
when  merchant = 'BWS' then cast(-0.053 as numeric)
when  merchant = 'Big W' then cast(-0.052 as numeric)
--when  merchant = 'Blackhawk Network' then 'Blackhawk-AUS'
when  merchant = 'Countdown' then cast(-0.025 as numeric)
when  merchant = 'Dan Murphys' then cast(-0.053 as numeric)
when  merchant = 'Digital Glue' then  cast(-0.053 as numeric)
when  merchant = 'EG Group' then  cast(-0.03 as numeric)
--when  merchant = 'Pitstop' then 
--when  merchant = 'Prezzee-AUS' then 
--when  merchant = 'Prezzee-NZ' then 
--when  merchant = 'RACV' then 
when  merchant = 'Supermarkets' then cast(-0.048 as numeric)
when  merchant = 'Shortys Liquor' then cast(-0.053 as numeric)
when  merchant = 'Woolworths Group Ltd' then cast(-0.048 as numeric)
--when  merchant = 'iGoDirect' then 
else cast(-0.053 as numeric)
end  charge_rate
from pdh_rd_quickcilver.qc_detail_transactions qc
left outer join
pdh_ref_ds.ref_store_details s
on s.store_id = left(qc.Outlet,5)
;

create or replace table wpay_analytics.qc_redemption_charges
as
with 
qc as 
(
	select 
	qc.*
	,rc.charge_rate
	,s.company
	,s.merchant_group
	,s.merchant_portal_mg
	,s.merchant_portal_cg
	,s.division
	,s.brand
	,s.site_name
	,s.invoice_group
	,case when TransactionType IN ('GIFT CARD REDEEM','GIFT CARD CANCEL REDEEM','GIFT CARD RELOAD')
			then Amount_Transacting_Merchants_Currency_Or_Points 
	end redemption_Amount_Transacting_Merchants_Currency_Or_Points
	,case when TransactionType IN ('GIFT CARD REDEEM','GIFT CARD CANCEL REDEEM','GIFT CARD RELOAD')
			then 1 
	end redemption_count
	from pdh_rd_quickcilver.qc_detail_transactions qc
	inner join
	pdh_ref_ds.ref_qc_redemption_charges_rate rc
	on rc.merchant = qc.merchant
	left outer join
	pdh_ref_ds.ref_store_details s
	on s.store_id = left(qc.Outlet,5)
)
,qc_redemption_charges as 
(
	select 
	CAST(EXTRACT (Year from TransactionDate) AS integer) as Calendar_Year
	,CAST(EXTRACT (Month from TransactionDate) AS integer) as Calendar_Month
	,cast(CAST(EXTRACT (Year from TransactionDate) AS string)||lpad(cast(EXTRACT (Month from TransactionDate) as string),2,'0') as integer) Calendar_Month_Nbr
	,cast('FY '||dd.fy as string) Fiscal_Year
	,cast(CAST(dd.fy AS string)||lpad(cast(dd.pofy as string),2,'0') as integer) Fiscal_Month_Nbr
	,case 
	when dd.pofy  = 1 then cast('FY '||dd.fy as string)||'-'||cast('01' as string)
	when dd.pofy  = 2 then cast('FY '||dd.fy as string)||'-'||cast('02' as string)
	when dd.pofy  = 3 then cast('FY '||dd.fy as string)||'-'||cast('03' as string)
	when dd.pofy  = 4 then cast('FY '||dd.fy as string)||'-'||cast('04' as string)
	when dd.pofy  = 5 then cast('FY '||dd.fy as string)||'-'||cast('05' as string)
	when dd.pofy  = 6 then cast('FY '||dd.fy as string)||'-'||cast('06' as string)
	when dd.pofy  = 7 then cast('FY '||dd.fy as string)||'-'||cast('07' as string)
	when dd.pofy  = 8 then cast('FY '||dd.fy as string)||'-'||cast('08' as string)
	when dd.pofy  = 9 then cast('FY '||dd.fy as string)||'-'||cast('09' as string)
	when dd.pofy  = 10 then cast('FY '||dd.fy as string)||'-'||cast('10' as string)
	when dd.pofy  = 11 then cast('FY '||dd.fy as string)||'-'||cast('11' as string)
	when dd.pofy  = 12 then cast('FY '||dd.fy as string)||'-'||cast('12' as string)
  end as Fiscal_Month 
	,cast('WK '||dd.wofy||' : '||fw_start_date as string) Fiscal_Week
	,*
	,charge_rate * Redemption_Amount_Transacting_Merchants_Currency_Or_Points charge_amount 
	from qc
	Inner JOIN `pdh_ref_ds.dim_date` as dd
	on dd.clndr_date = qc.TransactionDate
)
select *
from qc_redemption_charges
;


create or replace table wpay_analytics.qc_monthly_redemption_charges_summary														
as			
with qc as 
(											
	(
		SELECT
		'Calendar' Calendar_or_Fiscal_Period
		,cast(Calendar_Year as string) Yr
		,cast(case
		when Calendar_Month = 1 then cast(Calendar_Year as string)||'-01'
		when Calendar_Month = 2 then cast(Calendar_Year as string)||'-02'
		when Calendar_Month = 3 then cast(Calendar_Year as string)||'-03'
		when Calendar_Month = 4 then cast(Calendar_Year as string)||'-04'
		when Calendar_Month = 5 then cast(Calendar_Year as string)||'-05'
		when Calendar_Month = 6 then cast(Calendar_Year as string)||'-06'
		when Calendar_Month = 7 then cast(Calendar_Year as string)||'-07'
		when Calendar_Month = 8 then cast(Calendar_Year as string)||'-08'
		when Calendar_Month = 9 then cast(Calendar_Year as string)||'-09'
		when Calendar_Month = 10 then cast(Calendar_Year as string)||'-10'
		when Calendar_Month = 11 then cast(Calendar_Year as string)||'-11'
		when Calendar_Month = 12 then cast(Calendar_Year as string)||'-12'
		end as string)  Mnth
		,cast(Calendar_Month_Nbr as integer) Mnth_Nbr
		,case 
		when outletgroup = 'ALH-BWS' then 'AU'
		when outletgroup = 'ALH-Dan Murphys' then 'AU'
		when outletgroup = 'ALV - (ALH Venues)' then 'AU'    
		when outletgroup = 'BIG W' then 'AU'
		when outletgroup = 'BWS' then 'AU'
		when outletgroup = 'Blackhawk-AUS' then 'AU'
		when outletgroup = 'Countdown' then 'NZ'
		when outletgroup = 'Digital Glue-AUS' then 'AU'
		when outletgroup = 'EG APAC' then 'AU'
		when outletgroup = 'EG Group' then 'AU'
		when outletgroup = 'Endeavour-BWS' then 'AU'
		when outletgroup = 'Endeavour-Dan Murphys' then 'AU'
		when outletgroup = 'Liquor' then 'AU'
		when outletgroup = 'Pitstop-AUS' then 'AU'
		when outletgroup = 'Prezzee-AUS' then 'AU'
		when outletgroup = 'RACV-Store' then 'AU'
		when outletgroup = 'Supermarkets' then 'AU'
		when outletgroup = 'WW Metro' then 'AU'
		when outletgroup = 'Woolworths' then 'AU'
		when outletgroup = 'Woolworths Group Ltd' then 'AU'
		else 'AU'
		end country
		,case 
		when outletgroup = 'ALH-BWS' then 'EDG'
		when outletgroup = 'ALH-Dan Murphys' then 'EDG'
		when outletgroup = 'ALV - (ALH Venues)' then 'EDG'    
		when outletgroup = 'BIG W' then 'BIG W'
		when outletgroup = 'BWS' then 'EDG'
		when outletgroup = 'Blackhawk-AUS' then 'Bulk GC AU'
		when outletgroup = 'Countdown' then 'Countdown'
		when outletgroup = 'Digital Glue-AUS' then 'Bulk GC AU'
		when outletgroup = 'EG APAC' then 'EG Fuel'
		when outletgroup = 'EG Group' then 'EG Fuel'
		when outletgroup = 'Endeavour-BWS' then 'EDG'
		when outletgroup = 'Endeavour-Dan Murphys' then 'EDG'
		when outletgroup = 'Liquor' then 'EDG'
		when outletgroup = 'Pitstop-AUS' then 'Bulk GC AU'
		when outletgroup = 'Prezzee-AUS' then 'Bulk GC AU'
		when outletgroup = 'RACV-Store' then 'Bulk GC AU'
		when outletgroup = 'Supermarkets' then 'Supermarkets'
		when outletgroup = 'WW Metro' then 'Metro'
		when outletgroup = 'Woolworths' then 'Supermarkets'
		when outletgroup = 'Woolworths Group Ltd' then 'Supermarkets'
		else outletgroup
		end banner
		,Merchant														
		,OutletGroup														
		,OutletCode
		--,merchant_portal_mg
		,coalesce( 
			nullif(trim(merchant_portal_mg),'')
			,case 
				when OutletGroup = 'ALH-BWS' then 'ALH BWS'
				when OutletGroup = 'ALH-Dan Murphys' then "ALH Dan Murphy's"
				when OutletGroup = 'ALV - (ALH Venues)' then 'ALV'
				when OutletGroup = 'BIG W' then 'Big W'
				when OutletGroup = 'Countdown' then 'Countdown'
				when OutletGroup = 'Digital Glue-AUS' then 'Digital Glue'
				when OutletGroup = 'EG APAC' then 'EG Fuel'
				when OutletGroup = 'EG Group' then 'EG Fuel'
				when OutletGroup = 'Endeavour-BWS' then 'Endeavour BWS'
				when OutletGroup = 'Endeavour-Dan Murphys' then 'Endeavour Dan Murphy'
				when OutletGroup = 'Epay-AUS' then 'Everyday Pay'
				when OutletGroup = 'iGoDirect-AUS' then 'IGoDirectAcq'
				when OutletGroup = 'Liquor' then 'ALH Liquor'
				when OutletGroup = 'Pitstop-AUS' then 'PitStop'
				when OutletGroup = 'Prezzee-AUS' then 'Prezzee-AUS'
				when OutletGroup = 'Supermarkets' then 'Supermarkets'
				when OutletGroup = 'WW Metro' then 'METRO'
				end
		) merchant_portal_mg 
		,merchant_portal_cg
		,Count(If(TransactionType = 'GIFT CARD ACTIVATE', CardNumber , null)) - Count(If(TransactionType = 'GIFT CARD CANCEL ACTIVATE', CardNumber, null))As Net_Sales_Count
		,Sum(If(TransactionType = 'GIFT CARD ACTIVATE' , IFNULL(Amount_Transacting_Merchants_Currency_Or_Points,1000) + IFNULL(AdjustmentAmount_Transacting_Merchants_Currency_Or_Points,0),0)) 
		+ Sum(If(TransactionType = 'GIFT CARD REISSUE' , CardBalance_BaseCurrency_Or_Points,0)) 
		--+ Sum(If(TransactionType = 'GIFT CARD DEACTIVATE' , CardBalance_BaseCurrency_Or_Points,0)) 
		+ Sum(If(TransactionType = 'GIFT CARD CANCEL ACTIVATE' , IFNULL(Amount_Transacting_Merchants_Currency_Or_Points,-1000) + IFNULL(AdjustmentAmount_Transacting_Merchants_Currency_Or_Points,0),0))
		As Net_Sales
		,	Count(If(TransactionType = 'GIFT CARD CANCEL REDEEM', CardNumber , null)) +  
		Count(If(TransactionType = 'GIFT CARD REDEEM', CardNumber , null)) +  
		Count(If(TransactionType = 'GIFT CARD RELOAD', CardNumber, null))
		As Net_Redemptions_Count
		, Sum(If(TransactionType = 'GIFT CARD CANCEL REDEEM', IFNULL(Redemption_Amount_Transacting_Merchants_Currency_Or_Points,1000),0)) + 
		Sum(If(TransactionType = 'GIFT CARD REDEEM', IFNULL(Redemption_Amount_Transacting_Merchants_Currency_Or_Points,-1000),0))  + 
		Sum(If(TransactionType = 'GIFT CARD RELOAD', IFNULL(Redemption_Amount_Transacting_Merchants_Currency_Or_Points,1000),0))  
		As Net_Redemptions 
		,min(charge_rate) charge_rate
		,sum(charge_amount) charge_amount					
		FROM wpay_analytics.qc_redemption_charges														
		group by 1,2,3,4,5,6,7,8,9,10,11	
	)
	union all							
	(														
		SELECT														
		'Fiscal' Calendar_or_Fiscal_Period 														
		,cast(Fiscal_Year as string) Yr		
		,cast(Fiscal_Month as string) Mnth
		,cast(Fiscal_Month_Nbr as integer) Mnth_Nbr												
		,case 
		when outletgroup = 'ALH-BWS' then 'AU'
		when outletgroup = 'ALH-Dan Murphys' then 'AU'
		when outletgroup = 'ALV - (ALH Venues)' then 'AU'    
		when outletgroup = 'BIG W' then 'AU'
		when outletgroup = 'BWS' then 'AU'
		when outletgroup = 'Blackhawk-AUS' then 'AU'
		when outletgroup = 'Countdown' then 'NZ'
		when outletgroup = 'Digital Glue-AUS' then 'AU'
		when outletgroup = 'EG APAC' then 'AU'
		when outletgroup = 'EG Group' then 'AU'
		when outletgroup = 'Endeavour-BWS' then 'AU'
		when outletgroup = 'Endeavour-Dan Murphys' then 'AU'
		when outletgroup = 'Liquor' then 'AU'
		when outletgroup = 'Pitstop-AUS' then 'AU'
		when outletgroup = 'Prezzee-AUS' then 'AU'
		when outletgroup = 'RACV-Store' then 'AU'
		when outletgroup = 'Supermarkets' then 'AU'
		when outletgroup = 'WW Metro' then 'AU'
		when outletgroup = 'Woolworths' then 'AU'
		when outletgroup = 'Woolworths Group Ltd' then 'AU'
		else 'AU'
		end country
		,case 
		when outletgroup = 'ALH-BWS' then 'EDG'
		when outletgroup = 'ALH-Dan Murphys' then 'EDG'
		when outletgroup = 'ALV - (ALH Venues)' then 'EDG'    
		when outletgroup = 'BIG W' then 'BIG W'
		when outletgroup = 'BWS' then 'EDG'
		when outletgroup = 'Blackhawk-AUS' then 'Bulk GC AU'
		when outletgroup = 'Countdown' then 'Countdown'
		when outletgroup = 'Digital Glue-AUS' then 'Bulk GC AU'
		when outletgroup = 'EG APAC' then 'EG Fuel'
		when outletgroup = 'EG Group' then 'EG Fuel'
		when outletgroup = 'Endeavour-BWS' then 'EDG'
		when outletgroup = 'Endeavour-Dan Murphys' then 'EDG'
		when outletgroup = 'Liquor' then 'EDG'
		when outletgroup = 'Pitstop-AUS' then 'Bulk GC AU'
		when outletgroup = 'Prezzee-AUS' then 'Bulk GC AU'
		when outletgroup = 'RACV-Store' then 'Bulk GC AU'
		when outletgroup = 'Supermarkets' then 'Supermarkets'
		when outletgroup = 'WW Metro' then 'Metro'
		when outletgroup = 'Woolworths' then 'Supermarkets'
		when outletgroup = 'Woolworths Group Ltd' then 'Supermarkets'
		else outletgroup
		end banner
		,Merchant														
		,OutletGroup														
		,OutletCode
		--,merchant_portal_mg
		,coalesce( 
			nullif(trim(merchant_portal_mg),'')
			,case 
				when OutletGroup = 'ALH-BWS' then 'ALH BWS'
				when OutletGroup = 'ALH-Dan Murphys' then "ALH Dan Murphy's"
				when OutletGroup = 'ALV - (ALH Venues)' then 'ALV'
				when OutletGroup = 'BIG W' then 'Big W'
				when OutletGroup = 'Countdown' then 'Countdown'
				when OutletGroup = 'Digital Glue-AUS' then 'Digital Glue'
				when OutletGroup = 'EG APAC' then 'EG Fuel'
				when OutletGroup = 'EG Group' then 'EG Fuel'
				when OutletGroup = 'Endeavour-BWS' then 'Endeavour BWS'
				when OutletGroup = 'Endeavour-Dan Murphys' then 'Endeavour Dan Murphy'
				when OutletGroup = 'Epay-AUS' then 'Everyday Pay'
				when OutletGroup = 'iGoDirect-AUS' then 'IGoDirectAcq'
				when OutletGroup = 'Liquor' then 'ALH Liquor'
				when OutletGroup = 'Pitstop-AUS' then 'PitStop'
				when OutletGroup = 'Prezzee-AUS' then 'Prezzee-AUS'
				when OutletGroup = 'Supermarkets' then 'Supermarkets'
				when OutletGroup = 'WW Metro' then 'METRO'
				end
		) merchant_portal_mg 		
		,merchant_portal_cg
		,Count(If(TransactionType = 'GIFT CARD ACTIVATE', CardNumber , null)) - Count(If(TransactionType = 'GIFT CARD CANCEL ACTIVATE', CardNumber, null))As Net_Sales_Count
		,Sum(If(TransactionType = 'GIFT CARD ACTIVATE' , IFNULL(Amount_Transacting_Merchants_Currency_Or_Points,1000) + IFNULL(AdjustmentAmount_Transacting_Merchants_Currency_Or_Points,0),0)) 
		+ Sum(If(TransactionType = 'GIFT CARD REISSUE' , CardBalance_BaseCurrency_Or_Points,0)) 
		--+ Sum(If(TransactionType = 'GIFT CARD DEACTIVATE' , CardBalance_BaseCurrency_Or_Points,0)) 
		+ Sum(If(TransactionType = 'GIFT CARD CANCEL ACTIVATE' , IFNULL(Amount_Transacting_Merchants_Currency_Or_Points,-1000) + IFNULL(AdjustmentAmount_Transacting_Merchants_Currency_Or_Points,0),0))
		As Net_Sales
		,	Count(If(TransactionType = 'GIFT CARD CANCEL REDEEM', CardNumber , null)) +  
		Count(If(TransactionType = 'GIFT CARD REDEEM', CardNumber , null)) +  
		Count(If(TransactionType = 'GIFT CARD RELOAD', CardNumber, null))
		As Net_Redemptions_Count
		, Sum(If(TransactionType = 'GIFT CARD CANCEL REDEEM', IFNULL(Redemption_Amount_Transacting_Merchants_Currency_Or_Points,1000),0)) + 
		Sum(If(TransactionType = 'GIFT CARD REDEEM', IFNULL(Redemption_Amount_Transacting_Merchants_Currency_Or_Points,-1000),0))  + 
		Sum(If(TransactionType = 'GIFT CARD RELOAD', IFNULL(Redemption_Amount_Transacting_Merchants_Currency_Or_Points,1000),0))  
		As Net_Redemptions 
		,min(charge_rate) charge_rate
		,sum(charge_amount) charge_amount					
		FROM wpay_analytics.qc_redemption_charges														
		group by 1,2,3,4,5,6,7,8,9,10,11										
	)
)
, rnk as 
(
	select 
	*
	,row_number() over (partition by Calendar_or_Fiscal_Period order by mnth_nbr desc) as mnth_rnk
	from
	( 
		select distinct 
		Calendar_or_Fiscal_Period
		,mnth_nbr
		from qc
	)
	order by 1,3
)
select qc.*
from 
qc 
inner join 
rnk 
on qc.Calendar_or_Fiscal_Period = rnk.Calendar_or_Fiscal_Period
and qc.mnth_nbr = rnk.mnth_nbr
and rnk.mnth_rnk <= 12
;

create or replace view wpay_analytics.vw_qc_monthly_redemption_charges_summary
as select * from wpay_analytics.qc_monthly_redemption_charges_summary
;