truncate table pdh_analytics_ds.alipay_stml_store_level_rpt;
insert into pdh_analytics_ds.alipay_stml_store_level_rpt
(
WITH
  alipay AS (
  SELECT
    substring(Alipay.Reqstore,2,4) AS Alipay_StoreNumber,
    Alipay.ReqTxRef AS Alipay_Ordernumber,
    Alipay.reqdate AS Alipay_OrderDate,
    CAST( Alipay.reqtime AS STRING) AS Alipay_OrderTime,
  IF
    (FORMAT_TIME('%R',
        TIME(Alipay.reqtime)) <= "18:00:00",
      SUM((Alipay.ReqTotalAmt)),
      0) AS Alipay_CUTOFF_BEFORE_6,
  IF
    (FORMAT_TIME('%R',
        TIME(Alipay.reqtime)) > "18:00:00",
      SUM((Alipay.ReqTotalAmt)),
      0)AS Alipay_CUTOFF_AFTER_6
  FROM
    `pdh_rd_apm.alipay_linkly` Alipay
  WHERE
    Alipay.ReqMT = 200
    OR Alipay.ReqMT = 400
    AND Alipay.reqtype IN ('N',
      'N-',
      'R',
      'P')
  GROUP BY
    1,
    2,
    3,
    reqtime),
  a_stlm AS(
  SELECT
    Cast(Transaction_id as String) AS Astlm_order_number,
    store_id AS astlm_store_Number,
    Datetime(Payment_time) AS astlm_order_date_time,
    SUM(Amount) AS astlm_Amount
  FROM
    pdh_rd_apm.alipay_stlm
  GROUP BY
    1,
    2,
    3 )
SELECT
  DISTINCT AP.Alipay_StoreNumber,
  AP.Alipay_OrderDate,
  date(astlm_order_date_time) as astlm_order_date_time,
  ast.astlm_store_Number,
  SUM(ifnull(astlm_Amount,
      0)) AS ast_amount,
  SUM(ifnull(Alipay_CUTOFF_AFTER_6,
      0)) AS AP_CUTOFF_AFTER_6,
  SUM(ifnull(Alipay_CUTOFF_BEFORE_6,
      0)) AS Ap_CUTOFF_BEFORE_6,
IF
  ( SUM(ifnull(astlm_Amount,
        0))=SUM(ifnull(Alipay_CUTOFF_AFTER_6,
        0)) +SUM(ifnull(Alipay_CUTOFF_BEFORE_6,
        0)),
    "Matched",
    "Mismatched") AS Flag
FROM
  Alipay AP
left join 
  a_stlm ast
ON
  Alipay_Ordernumber = Astlm_order_number and Alipay_StoreNumber = astlm_store_Number 
GROUP BY
  1,
  2,
  3,
  4
)