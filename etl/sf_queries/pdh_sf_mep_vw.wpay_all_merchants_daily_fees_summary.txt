TRUNCATE TABLE `pdh_sf_mep_vw.wpay_all_merchants_daily_fees_summary`;
INSERT INTO `pdh_sf_mep_vw.wpay_all_merchants_daily_fees_summary`
(
	clndr_date
	,calendar_week
	,switch_tran_date
	,transaction_date
	,max_transaction_date_flag
	,fortnight_date_flag
	,fiscal_week
	,max_transaction_week_flag
	,transaction_week
	,transaction_week_start_date
	,transaction_week_end_date
	,max_transaction_month_flag
	,transaction_month
	,transaction_month_start_date
	,transaction_month_end_date
	,fy_start_date
	,store_id
	,issuer
	,approval_flag
	,account
	,link_route
	,scheme
	,card_type
	,orig_card_type
	,dom_int_ind
	,tran_type_description
	,fee_indicator
	,company
	,invoice_group
	,merchant_group
	,division
	,brand
	,location
	,site_name
	,suburb
	,state
	,postcode
	,country
	,scheme_card_type
	,transaction_count
	,settlement_amount_inc_gst
	,interchange_fees_invoiced_ex_gst
	,interchange_fees_tran_count
	,processing_fees_ex_gst
	,processing_fees_tran_count
	,fraud_fees_ex_gst
)
with agg_tran_data as 
( select * from ( select tbl_sml_merchant_fees_rpt.switch_tran_date as switch_tran_date, tbl_sml_merchant_fees_rpt.store_id as store_id, tbl_sml_merchant_fees_rpt.issuer as issuer, tbl_sml_merchant_fees_rpt.approval_flag as approval_flag, tbl_sml_merchant_fees_rpt.account as account, tbl_sml_merchant_fees_rpt.link_route as link_route, tbl_sml_merchant_fees_rpt.scheme as scheme, tbl_sml_merchant_fees_rpt.card_type as card_type, tbl_sml_merchant_fees_rpt.orig_card_type as orig_card_type, tbl_sml_merchant_fees_rpt.dom_int_ind as dom_int_ind, tbl_sml_merchant_fees_rpt.tran_type_description as tran_type_description, tbl_sml_merchant_fees_rpt.fee_indicator as fee_indicator, tbl_sml_merchant_fees_rpt.company as company, tbl_sml_merchant_fees_rpt.invoice_group as invoice_group, tbl_sml_merchant_fees_rpt.merchant_group as merchant_group, tbl_sml_merchant_fees_rpt.division as division, tbl_sml_merchant_fees_rpt.brand as brand, tbl_sml_merchant_fees_rpt.location as location, tbl_sml_merchant_fees_rpt.site_name as site_name, tbl_sml_merchant_fees_rpt.suburb as suburb, tbl_sml_merchant_fees_rpt.state as state, tbl_sml_merchant_fees_rpt.postcode as postcode, tbl_sml_merchant_fees_rpt.country as country, case `tbl_sml_merchant_fees_rpt`.`scheme` when "DINERS" then "CREDIT" when "AMEX" then "CREDIT" when "EFTPOS" then "DEBIT" when "FUEL CARDS" then "FUEL CARDS" when "GIFT CARDS" then "GIFT CARDS" When "PAYPAL" then "APM" when "MASTERCARD" then Case `tbl_sml_merchant_fees_rpt`.`card_type` when "CREDIT" then "CREDIT" When "DEBIT" then "DEBIT" else "" end when "VISA" then Case `tbl_sml_merchant_fees_rpt`.`card_type` when "CREDIT" then "CREDIT" When "DEBIT" then "DEBIT" else "" end when "UPI" then "CREDIT" end  as scheme_card_type,    dd.fy_start_date as fy_start_date, wofy fiscal_week, dd.clndr_date as clndr_date, sum(tbl_sml_merchant_fees_rpt.vcalc_transaction_count) as transaction_count, sum(cast(tbl_sml_merchant_fees_rpt.vcalc_settlement_amount_inc_gst as float64)) as settlement_amount_inc_gst, sum(tbl_sml_merchant_fees_rpt.vcalc_interchange_fees_invoiced_ex_gst) as interchange_fees_invoiced_ex_gst, sum(tbl_sml_merchant_fees_rpt.vcalc_interchange_fees_tran_count) as interchange_fees_tran_count, sum(cast(tbl_sml_merchant_fees_rpt.vcalc_processing_fees_ex_gst as float64)) as processing_fees_ex_gst, sum(tbl_sml_merchant_fees_rpt.vcalc_processing_fees_tran_count) as processing_fees_tran_count, sum(cast(tbl_sml_merchant_fees_rpt.fraud_fees_ex_gst as float64)) as fraud_fees_ex_gst, from pdh_analytics_ds.tbl_sml_merchant_fees_rpt tbl_sml_merchant_fees_rpt left join  pdh_ref_ds.dim_date dd on tbl_sml_merchant_fees_rpt.switch_tran_date =dd.clndr_date 
where 
switch_tran_date >= date_add(date_add(date_trunc(date_add(current_date, INTERVAL -1 DAY),week), INTERVAL 1 DAY), INTERVAL -12 week) 

and company <> 'Endeavour' group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19, 20,21,22,23,24,25,26,27 order by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19, 20,21,22,23,24,25,26,27 ) 
union all 
( select `tbl_endeavour_fees_rpt`.`switch_tran_date` as `switch_tran_date`, `tbl_endeavour_fees_rpt`.`store_id` as `store_id`, `tbl_endeavour_fees_rpt`.`issuer` as `issuer`, `tbl_endeavour_fees_rpt`.`approval_flag` as `approval_flag`, `tbl_endeavour_fees_rpt`.`account` as `account`, `tbl_endeavour_fees_rpt`.`link_route` as `link_route`, `tbl_endeavour_fees_rpt`.`scheme` as `scheme`, `tbl_endeavour_fees_rpt`.`card_type` as `card_type`, `tbl_endeavour_fees_rpt`.`orig_card_type` as `orig_card_type`, `tbl_endeavour_fees_rpt`.`dom_int_ind` as `dom_int_ind`, `tbl_endeavour_fees_rpt`.`tran_type_description` as `tran_type_description`, `tbl_endeavour_fees_rpt`.`fee_indicator` as `fee_indicator`, `tbl_endeavour_fees_rpt`.`company` as `company`, `tbl_endeavour_fees_rpt`.`invoice_group` as `invoice_group`, `tbl_endeavour_fees_rpt`.`merchant_group` as `merchant_group`, `tbl_endeavour_fees_rpt`.`division` as `division`, `tbl_endeavour_fees_rpt`.`brand` as `brand`, `tbl_endeavour_fees_rpt`.`location` as `location`, tbl_endeavour_fees_rpt.site_name as site_name, tbl_endeavour_fees_rpt.suburb as suburb, tbl_endeavour_fees_rpt.state as state, tbl_endeavour_fees_rpt.postcode as postcode, tbl_endeavour_fees_rpt.country as country, case `tbl_endeavour_fees_rpt`.`scheme` when "DINERS" then "CREDIT" when "AMEX" then "CREDIT" when "EFTPOS" then "DEBIT" when "FUEL CARDS" then "FUEL CARDS" when "GIFT CARDS" then "GIFT CARDS" When "PAYPAL" then "APM" when "MASTERCARD" then Case `tbl_endeavour_fees_rpt`.`card_type` when "CREDIT" then "CREDIT" When "DEBIT" then "DEBIT" else "" end when "VISA" then Case `tbl_endeavour_fees_rpt`.`card_type` when "CREDIT" then "CREDIT" When "DEBIT" then "DEBIT" else "" end when "UPI" then "CREDIT" end as scheme_card_type, `dd`.`fy_start_date` as `fy_start_date`, wofy fiscal_week, `dd`.`clndr_date` as `clndr_date`, sum(`tbl_endeavour_fees_rpt`.`vcalc_transaction_count`) as `transaction_count`, sum( cast(`tbl_endeavour_fees_rpt`.`vcalc_settlement_amount_inc_gst` as float64)) as `settlement_amount_inc_gst`, sum(`tbl_endeavour_fees_rpt`.`vcalc_interchange_fees_invoiced_ex_gst`) as `interchange_fees_invoiced_ex_gst`, sum( `tbl_endeavour_fees_rpt`.`vcalc_interchange_fees_tran_count`) as `interchange_fees_tran_count`, sum( cast(`tbl_endeavour_fees_rpt`.`vcalc_processing_fees_ex_gst` as float64)) as `processing_fees_ex_gst`, sum(`tbl_endeavour_fees_rpt`.`vcalc_processing_fees_tran_count`) as `processing_fees_tran_count`, sum(cast(`tbl_endeavour_fees_rpt`.`fraud_fees_ex_gst` as float64)) as `fraud_fees_ex_gst` from `pdh_analytics_ds`.`tbl_edg_fees_rpt` `tbl_endeavour_fees_rpt` left join `pdh_ref_ds.dim_date` dd on `tbl_endeavour_fees_rpt`.`switch_tran_date` = `dd`.`clndr_date`  
where 
switch_tran_date > date_add(date_add(date_trunc(date_add(current_date, INTERVAL -1 DAY),week), INTERVAL 1 DAY), INTERVAL -12 week)

group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19, 20,21,22,23,24,25,26,27 order by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19, 20,21,22,23,24,25,26,27 ) 
union all  
( select `tbl_egfuel_fees_rpt`.`switch_tran_date` as `switch_tran_date`, `tbl_egfuel_fees_rpt`.`store_id` as `store_id`, `tbl_egfuel_fees_rpt`.`issuer` as `issuer`, `tbl_egfuel_fees_rpt`.`approval_flag` as `approval_flag`, `tbl_egfuel_fees_rpt`.`account` as `account`, `tbl_egfuel_fees_rpt`.`link_route` as `link_route`, `tbl_egfuel_fees_rpt`.`scheme` as `scheme`, `tbl_egfuel_fees_rpt`.`card_type` as `card_type`, `tbl_egfuel_fees_rpt`.`orig_card_type` as `orig_card_type`, `tbl_egfuel_fees_rpt`.`dom_int_ind` as `dom_int_ind`, `tbl_egfuel_fees_rpt`.`tran_type_description` as `tran_type_description`, `tbl_egfuel_fees_rpt`.`fee_indicator` as `fee_indicator`, `tbl_egfuel_fees_rpt`.`company` as `company`, `tbl_egfuel_fees_rpt`.`invoice_group` as `invoice_group`, `tbl_egfuel_fees_rpt`.`merchant_group` as `merchant_group`, `tbl_egfuel_fees_rpt`.`division` as `division`, `tbl_egfuel_fees_rpt`.`brand` as `brand`, `tbl_egfuel_fees_rpt`.`location` as `location`, tbl_egfuel_fees_rpt.site_name as site_name, tbl_egfuel_fees_rpt.suburb as suburb, tbl_egfuel_fees_rpt.state as state, tbl_egfuel_fees_rpt.postcode as postcode, tbl_egfuel_fees_rpt.country as country, case `tbl_egfuel_fees_rpt`.`scheme` when "DINERS" then "CREDIT" when "AMEX" then "CREDIT" when "EFTPOS" then "DEBIT" when "FUEL CARDS" then "FUEL CARDS" when "GIFT CARDS" then "GIFT CARDS" When "PAYPAL" then "APM" when "MASTERCARD" then Case `tbl_egfuel_fees_rpt`.`card_type` when "CREDIT" then "CREDIT" When "DEBIT" then "DEBIT" else "" end when "VISA" then Case `tbl_egfuel_fees_rpt`.`card_type` when "CREDIT" then "CREDIT" When "DEBIT" then "DEBIT" else "" end when "UPI" then "CREDIT" end  as scheme_card_type, `dd`.`fy_start_date` as `fy_start_date`, wofy fiscal_week, `dd`.`clndr_date` as `clndr_date`, sum(`tbl_egfuel_fees_rpt`.`vcalc_transaction_count`) as `transaction_count`, sum(cast(`tbl_egfuel_fees_rpt`.`vcalc_settlement_amount_inc_gst` as float64)) as `settlement_amount_inc_gst`, sum(`tbl_egfuel_fees_rpt`.`vcalc_interchange_fees_invoiced_ex_gst`) as `interchange_fees_invoiced_ex_gst`, sum(`tbl_egfuel_fees_rpt`.`vcalc_interchange_fees_tran_count`) as `interchange_fees_tran_count`, sum(`tbl_egfuel_fees_rpt`.`vcalc_processing_fees_ex_gst`) as `processing_fees_ex_gst`, sum(`tbl_egfuel_fees_rpt`.`vcalc_processing_fees_tran_count`) as `processing_fees_tran_count`, sum(cast(`tbl_egfuel_fees_rpt`.`fraud_fees_ex_gst` as float64)) as `fraud_fees_ex_gst` from `pdh_analytics_ds`.`tbl_egfuel_fees_rpt` `tbl_egfuel_fees_rpt` left join  `pdh_ref_ds.dim_date` dd on `tbl_egfuel_fees_rpt`.`switch_tran_date` = `dd`.`clndr_date` 
where 
switch_tran_date >= date_add(date_add(date_trunc(date_add(current_date, INTERVAL -1 DAY),week), INTERVAL 1 DAY), INTERVAL -12 week)

and company <> 'Endeavour' group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19, 20,21,22,23,24,25,26,27 order by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19, 20,21,22,23,24,25,26,27 ) ) 
, max_fiscal_date as ( select max(switch_tran_date) fiscal_date from agg_tran_data ) 
, fortnight_date_range as ( select distinct switch_tran_date tran_date from agg_tran_data where switch_tran_date between ( select date_add(fiscal_date, INTERVAL -14 DAY) from max_fiscal_date ) and ( select date_add(fiscal_date, INTERVAL -1 DAY) from max_fiscal_date ) ) 
, max_fiscal_week as ( select distinct fiscal_week fiscal_week from agg_tran_data where switch_tran_date = ( select max(switch_tran_date) from agg_tran_data ) ) 
, max_fiscal_month as ( select distinct format_date("%b %Y",switch_tran_date) transaction_month from agg_tran_data where switch_tran_date = ( select max(switch_tran_date) from agg_tran_data ) ) 
select 
-- Calendar -- 
clndr_date
, "Wk- "||lpad(cast(EXTRACT(WEEK FROM DATE_TRUNC(date_add(switch_tran_date, INTERVAL 6 DAY) ,week)) as string),2,'0')|| " : " || format_date("%d-%b",date_add(date_trunc(date_add(switch_tran_date, INTERVAL -1 DAY),week), INTERVAL 1 DAY)) || " to " || format_date("%d-%b",date_add(date_trunc(date_add(switch_tran_date, INTERVAL -1 DAY),week), INTERVAL 7 DAY)) as calendar_week
-- Fiscal -- 
, switch_tran_date
, switch_tran_date as transaction_date
, case when mfd.fiscal_date is not null then 'Y' else 'N' end max_transaction_date_flag
, case when fdr.tran_date is not null then 'Y' else 'N' end fortnight_date_flag
, cast(atd.fiscal_week + 2 as int64) fiscal_week
, case when mfw.fiscal_week is not null then 'Y' else 'N' end max_transaction_week_flag
, "Wk- "||lpad(cast((atd.fiscal_week ) as string),2,'0')|| " : " || format_date("%d-%b",date_add(date_trunc(date_add(switch_tran_date, INTERVAL -1 DAY),week), INTERVAL 1 DAY)) || " to " || format_date("%d-%b",date_add(date_trunc(date_add(switch_tran_date, INTERVAL -1 DAY),week), INTERVAL 7 DAY)) as transaction_week
, date_add(date_trunc(date_add(switch_tran_date, INTERVAL -1 DAY),week), INTERVAL 1 DAY) transaction_week_start_date
, date_add(date_trunc(date_add(switch_tran_date, INTERVAL -1 DAY),week), INTERVAL 7 DAY) transaction_week_end_date
, case when mfm.transaction_month is not null then 'Y' else 'N' end max_transaction_month_flag
, format_date("%b %Y",switch_tran_date) transaction_month
, date_trunc(switch_tran_date,month) transaction_month_start_date
, last_day(switch_tran_date, month) transaction_month_end_date
, fy_start_date
-- Dimensions -- 
, store_id
, issuer
, approval_flag
, account
, link_route
, scheme
, card_type
, orig_card_type
, dom_int_ind
, tran_type_description
, fee_indicator
, company
, invoice_group
, merchant_group
, division
, brand
, location
, site_name
, suburb
, state
, postcode
, country
, scheme_card_type
-- Metrics --    
, transaction_count
, settlement_amount_inc_gst
, interchange_fees_invoiced_ex_gst
, interchange_fees_tran_count
, processing_fees_ex_gst
, processing_fees_tran_count
, fraud_fees_ex_gst 
from agg_tran_data atd 
left outer join 
max_fiscal_date mfd 
on mfd.fiscal_date = atd.switch_tran_date 
left outer join fortnight_date_range fdr 
on fdr.tran_date = atd.switch_tran_date 
left outer join 
max_fiscal_week mfw 
on mfw.fiscal_week = atd.fiscal_week 
left outer join max_fiscal_month mfm 
on mfm.transaction_month = format_date("%b %Y",atd.switch_tran_date) 
; 
